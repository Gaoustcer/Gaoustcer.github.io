---
layout:     post
title:      计算机体系结构——Tomasulo算法
subtitle:   计算机体系结构——Tomasulo算法
date:       2021-05-27
author:     Haihan Gao
header-img: img/post-bg-swift2.jpg
catalog: true
tags:
    - Computer Architecture
    - Course review
---
# 计算机体系结构——Tomasulo算法

## 创新

* 硬件上寄存器重命名
* 所有执行单元增加一个保留站
* 公共的数据总线

### Tomasulo算法&&记分牌

* 控制和缓存分布在各个部件中：Reservation Station
* 指令中的寄存器在RS中用寄存器值或指向RS的指针代替
  * RS比寄存器多，可以做更多优化
* 传给FU的结果来自RS而不是寄存器
  * FU计算结果通过CDB广播到所有功能部件(定向路径)/寄存器文件中
* 可以跨越分支-分支预测 Reorder Buffer
* Load/Store操作存在Buffer

### 硬件并行化

* Reservation Station个数即为可以功能部件上可以并行执行的指令个数
* Load/Store可以支持多个Load/store操作
* AGU：地址生成部件

![image-20210522155522567](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20210522155522567.png)

## Overview

* 保留站实现寄存器重命名，保留站的空间比寄存器的数目多
* 通用数据总线实现到每个保留站和寄存器堆以及存储缓冲区的广播
* 分支指令后续的指令，只能在分支指令执行完毕后才能执行

数据依赖包括三种：RAW,WAR,WAW，顺序执行的流水线可以通过旁路和stall解决RAW真依赖。乱序处理器还会有WAR和WAW，需要通过重命名寄存器消除

## 硬件实现寄存器重命名

使用保留站，每个功能部件都有一个保留站，每条指令发射之后进入保留站，保留站内的条目比物理寄存器数目多，可以通过重命名解决WAR和WAW依赖

* 冒险检测和执行控制是分布式的，每个保留站决定哪条指令可以执行
* CDB可以广播到任意一个保留站，保留站中一个原操作数还在等待其它指令时，这个保留站会检测CDB的状态知道执行结果出现在CDB中

举例：

* 功能部件：加法器&乘法器
* 保留站：存放发射了的指令以及实际的源操作数，以及用于冒险检测和执行控制的信息
* 存储缓冲区、加载缓冲区：保存地址-数据条目
  * 保存等待有效地址计算完成的load指令条目
  * 保存当代内存有效的load指令条目
  * 保存等待CDB总线可用的数据
* CDB：可以向保留站、存储缓冲区和寄存器组广播

## Tomasulo执行过程

### 发射(Issue)

* 指令队列队首的指令出队
* 队首的指令需要使用的执行单元保留站有空闲空间则发射，否则结构冒险并等待
* 只判断结构相关
* 发射到保留站的指令对需要的源操作数进行跟踪，如果源操作数还没准备好，则在保留站中写入相关的信息跟踪源操作数，解决WAR和WAW->寄存器重命名解决这个问题

### 执行(EX)

* 源操作数不可用则监控CDB知道源操作数都可用，指令才会执行，解决RAW
* 如果一个保留站在一个时钟周期内有多条指令可以执行，需要由硬件决定执行什么指令
* 内存的数据冒险很难消除，因此load/store指令需要按照源程序顺序指令
* 控制相关我们认为程序序中分支指令之后的指令必须在分支指令执行之后执行
* 操作数准备好进入EX阶段

### 写回

* 写回CDB总线
* 由CDB总线广播到各个保留站
* CDB总线：64bits数据，4bits源地址标识(产生数据的地址)->收到数据的部件需要进行匹配，判断是否需要写

### 记号

* Op指令执行的操作
* Qi Qk产生指令需要的源操作数保留站标签，0表示真实的值已经存入保留站
* Vi Vk原操作数的值，store缓冲区有Vk域，用于存放写入存储器的值
* A 存放存储器地址，最初存放的是立即数，计算出有效地址后，存放需要写入存储器的值
* Busy 该保留站或者对应的执行单元是否忙
* Register result status：存在写寄存器的操作，知识写寄存器的部件
  * Qi寄存器堆标识，写入该寄存器的是哪个保留站Qi中的指令，0表示没有保留站中的指令需要写入该寄存器

## 流水线控制

### ISSUE

#### FU

##### wait until

station r is empty

##### Action or bookkeeping

if $Register[rs].Qi\neq 0$,then $RS[r].Qj:=RegisterStat[rs].Qi$ else $RS[r].Vj=Reg[rs] RS[r].Qj:=0$