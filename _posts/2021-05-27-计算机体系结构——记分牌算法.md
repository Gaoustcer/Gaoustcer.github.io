---
layout:     post
title:      计算机体系结构——记分牌算法
subtitle:   计算机体系结构——记分牌算法
date:       2021-05-27
author:     Haihan Gao
header-img: img/post-bg-swift2.jpg
catalog: true
tags:
    - Computer Architecture
    - Course review
---
# 计算机体系结构——记分牌算法

## 硬件指令流调度

### 优点

* 无法编译时确定指令相关
* 可以实现不同硬件的适配(编译器/静态指令流调度需要了解具体硬件结构)->二进制兼容
* 基本思想：允许stall后的指令继续向前流动(乱序执行)，操作数准备好就能执行(数据流驱动)

### 硬件方案

* 记分牌
* T-算法

## 记分牌方案

### 基本结构

* 程序执行
  * 取指令
    * 来自I-cache
    * 取到指令窗口中
  * 译码
    * issue-发射，译码，检测结构相关
    * 读操作数(前提是没有数据相关)，Read Operands
  * EX(包括访存)
  * WB
* 记分牌：记录每条指令和功能部件的状态
* 源自CDC6600
  * 顺序发射，乱序执行，乱序完成
  * 10个功能部件
  * 10个I/O处理器(多线程技术)
  * interlock解决相关，没有寄存器重命名

### 乱序执行数据相关的处理

#### WAR相关

* 对操作排队(按照程序逻辑序列执行)
* 仅仅在读操作数阶段读寄存器(RO阶段)，IF,ID段仍然有序

#### WAW相关

* 检测到相关，停止发射这条指令，直到前一条指令执行完成
* 多个功能部件保证并行是可能的(功能部件流水化)

### 指令执行的四个阶段

#### ISSUE

* 需要的功能部件是否空闲？
* 是否存在WAW相关？

#### RO

* 没有数据相关取操作数(RAW相关)
* 检测操作数是否有效

#### EX

* 执行结束需要通知记分牌

#### WR

* 记分牌得到功能部件执行完毕信息，记分牌检测WAR相关，避免**先写**
* 存在WAR相关，暂停写

### 记分牌的结构

* Instruction status：发射的各条指令处于什么状态
* Function unit status-功能部件状态，记录有关功能部件的九个参量
  * busy功能部件是否空闲
  * Op功能部件正在进行的操作
  * Fi目的寄存器**编号**
  * Fj Fk源寄存器**编号**
  * Qi Qj产生源操作数Fj Fk的功能部件编号——数据依赖
  * Rj Rk标识源操作数是否就绪的标志
* register result status——记录对寄存器进行写操作的功能部件(WAW相关)
  * 字段为0，代表没有功能部件写寄存器

### 记分牌控制

#### ISSUE

##### 准入条件

* 使用的功能部件不忙:Not busy
* 寄存器结果状态表：目的寄存器不被写

##### 进入ISSUE修改记分牌

* 修改功能部件状态：功能部件不忙，功能部件操作->并不是执行时才修改
* Qi Qj：查找寄存器结果状态表，如果为0代表写源寄存器的指令已经执行完毕
* Rj Rk：Qi，Qj为0则为1

#### Read Operand

##### 准入条件

Rj Rk均为真

##### 更新记分牌

Rj，Rk=No **标记源操作数已经被读走**

#### WR(判断WAR)

##### 准入条件

* 对于发射出的指令，源寄存器和写回段的目的寄存器是否一样
  * 不一样，则不存在相关
* 或者，对于用到这条指令目的操作数的指令f,Fj(f)=No，代表已经被读走

##### 更新记分牌

* 修改所有原操作状态，传递消息

### 其它需要注意的地方

* 顺序发射：前一条指令没有发射后一条指令不能发射
* 相当于使用记分牌实现数据转发