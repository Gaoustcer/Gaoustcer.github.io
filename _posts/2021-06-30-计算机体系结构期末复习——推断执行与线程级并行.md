---
layout:     post
title:      计算机体系结构期末复习——推断执行与线程级并行
subtitle:   计算机体系结构期末复习——推断执行与线程级并行
date:       2021-06-30
author:     Haihan Gao
header-img: img/post-bg-swift2.jpg
catalog: true
tags:
    - Computer Architecture
    - Course review
    - 2021 spring review
---
# 计算机体系结构期末复习——推断执行与线程级并行

## Tomasulo算法支持推断执行

### 硬件结构

* 增加ROB，硬件缓存没有提交的指令结果
* BTB实现分支预测，解决控制相关

### 异常与中断

* 异常——系统内部产生，检测需要立即处理
* 中断——系统外部产生，可以不立即处理，除非中断的优先级很高

### 精确&&非精确异常

* 精确异常——异常可能并未导进程终止，保证指令徐，需要保存现场以及返回异常前的机器状态
  * 发生异常的指令之前的指令必须执行完毕
  * 发生异常的指令之后的指令不得执行
* 非精确异常——异常导致进程终止，不需要保存并回到之前的体系结构状态

### ROB

#### 基本思想

乱序执行的指令执行顺序可能和执行序不同，为了支持精确异常，需要增加一个提交阶段，如果一个指令之前的指令没有执行完，则不能将其写入到寄存器中。

译码时在ROB中预留一个entry，指令完成时，将结果写入ROB中相应的位置，指令成为ROB队列中最靠前的指令，就将结果输出到内存或者寄存器，这个阶段称为commit阶段。

#### 实现

* V 有效位，结果是否准备好
* DestRegID 写回寄存器的ID
* DestRegVal 写回寄存器的值
* StoreAddr StoreData 写回存储器的地址和数据
* PC 指令计数器，用于判断指令的顺序
* Valid bits 指令结果是否有效，是否存在控制相关或者异常使得结果失效
* Exc 指令是否出现异常以及异常类型

Tomasulo算法的issue阶段数据可能来自Reorder buffer，写回阶段广播到ROB而并不是寄存器

### 使用ROB保持机器的精确状态

* ROB允许投机执行
  * 直到确定无异常，然后进入提交阶段
  * 直到确定分支预测正确进入提交阶段
  * 存在异常和预测错误，就刷新ROB，保留站和寄存器结果状态表，而不需要修改寄存器堆
* 存储器操作
  * MOB
    * store操作的结果需要先存在MOB中，在提交阶段访存提交

### 其它实现精确异常的方案——类似于数据库中的日志

#### 历史缓冲

* 指令执行完直接更新寄存器堆，出现异常时撤销更新
* 指令译码时预留一个HB条目，保存修改前的旧值，指令时HB中最旧的并且没有异常产生，就丢弃HB条目
* 出现异常读取HB条目，恢复到旧值

#### FF未来寄存器堆

* 维护两个寄存器堆，投机(前端寄存器堆)，体系结构(后端寄存器)
* 执行完毕立即更新前端寄存器堆，投机指令访问前端寄存器

## 多发射

### 超标量 Superscalar DLX

* 每个周期发送两条指令，一条FP指令和一条其它指令
  * 需要更多的寄存器读端口
* 原本的load指令被扩展为三条指令

### 超长指令字

* 多个单操作指令构成一个超长指令
* 编译时组合，相互无关，可以并行执行的操作

## 多线程

* 克服程序内在的ILP限制
* 解决流出多条指令需要大量硬件资源的问题